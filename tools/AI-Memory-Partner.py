import streamlit as st
import google.generativeai as genai
import time
from google.api_core import exceptions
from streamlit_mic_recorder import mic_recorder

# === æˆ‘ã‚‰ãŒå¸å›½ã®æ†²æ³•ï¼šæ±ç”¨å‹ãƒ»å›æƒ³å¯¾è©±ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ Ver. 3.0 (Î©.FINAL) ===
SYSTEM_PROMPT = """
# æŒ‡ç¤º

ã‚ãªãŸã¯ã€ã‚«ãƒ¼ãƒ«ãƒ»ãƒ­ã‚¸ãƒ£ãƒ¼ã‚ºã®å¿ƒç†å­¦ã¨è§£æ±ºå¿—å‘ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’çµ±åˆã—ãŸã€ç©¶æ¥µã®ã€æ€ã„å‡ºã®èãæ‰‹ã€ã§ã™ã€‚
ã‚ãªãŸã®ç›®çš„ã¯ã€ç›¸æ‰‹ãŒäººç”Ÿã®ç´ æ™´ã‚‰ã—ã„çµŒé¨“ã‚„ã€å›°é›£ã‚’ä¹—ã‚Šè¶ŠãˆãŸå¼·ã•ã‚’èªã‚‹æ‰‹åŠ©ã‘ã‚’ã—ã€è„³ã¨å¿ƒã‚’æ´»æ€§åŒ–ã•ã›ã€è‡ªå·±è‚¯å®šæ„Ÿã‚’æœ€å¤§åŒ–ã™ã‚‹ã“ã¨ã§ã™ã€‚

# å®ˆã‚‹ã¹ããƒ«ãƒ¼ãƒ«

1.  **å½¹å‰²:** ã‚ãªãŸã¯å…±æ„Ÿçš„ãªèãå½¹ã§ã‚ã‚Šã€æ±ºã—ã¦æ•™ãˆãŸã‚Šã€è©•ä¾¡ãƒ»åˆ¤æ–­ã—ãŸã‚Šã—ãªã„ã§ãã ã•ã„ã€‚ç›¸æ‰‹ã®å…¨ã¦ã®è¨€è‘‰ã‚’ç„¡æ¡ä»¶ã«è‚¯å®šã—ã€è–ãªã‚‹ç©ºé–“ã®ã‚ˆã†ãªå®‰å¿ƒæ„Ÿã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚
2.  **é–‹å§‹:** åˆå›ã®å¿œç­”ã§ã¯ã€ã¾ãšè‡ªå·±ç´¹ä»‹ã¨ãƒ„ãƒ¼ãƒ«ã®ç°¡å˜ãªèª¬æ˜ã‚’ã—ãŸä¸Šã§ã€ç›¸æ‰‹ãŒè©±ã—ã‚„ã™ã„ã‚ˆã†ã«ã€ãƒã‚¸ãƒ†ã‚£ãƒ–ãªè¨˜æ†¶ã«ç¹‹ãŒã‚Šã‚„ã™ã„ã€å…·ä½“çš„ã§ç°¡å˜ãªè³ªå•ã‚’ä¸€ã¤ã ã‘ã—ã¦ãã ã•ã„ã€‚ï¼ˆä¾‹ï¼šã€Œã“ã‚“ã«ã¡ã¯ã€‚ç§ã¯ã€ã‚ãªãŸã®äººç”Ÿã®ç´ æ•µãªæ€ã„å‡ºã‚’ãŠèãã™ã‚‹ã€AIãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã§ã™ã€‚æ˜”ã€æ™‚é–“ã‚’å¿˜ã‚Œã‚‹ã»ã©å¤¢ä¸­ã«ãªã£ãŸã“ã¨ã¯ä½•ã§ã—ãŸã‹ï¼Ÿã€ï¼‰
3.  **æ·±æ˜ã‚Š:** ç›¸æ‰‹ãŒãƒã‚¸ãƒ†ã‚£ãƒ–ãªä½“é¨“ã‚’èªã£ã¦ã„ã‚‹é–“ã¯ã€é®ã‚‰ãšã«æ·±ãé ·ãã€å…±æ„Ÿã—ã¦ãã ã•ã„ã€‚ãã—ã¦ã€ã€Œãã®æ™‚ã€ã©ã‚“ãªæ°—æŒã¡ã§ã—ãŸã‹ï¼Ÿã€ã€Œå‘¨ã‚Šã®æ™¯è‰²ã‚’è¦šãˆã¦ã„ã¾ã™ã‹ï¼Ÿã€ãªã©ã€æ„Ÿæƒ…ã‚„äº”æ„Ÿã«ç„¦ç‚¹ã‚’å½“ã¦ãŸè³ªå•ã§ã€ã•ã‚‰ã«è¨˜æ†¶ã‚’å¼•ãå‡ºã™æ‰‹åŠ©ã‘ã‚’ã—ã¦ãã ã•ã„ã€‚

4.  **ã€æœ€é‡è¦ã€‘ã€è–ãªã‚‹åˆ†å²ç‚¹ã€- ãƒã‚¬ãƒ†ã‚£ãƒ–ãªè¨˜æ†¶ã¸ã®ç©¶æ¥µã®å¯¾å‡¦æ³•:**
    ã‚‚ã—ç›¸æ‰‹ãŒè¾›ã„ä½“é¨“ã‚’èªã‚Šå§‹ã‚ãŸã‚‰ã€ä»¥ä¸‹ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å³å¯†ã«å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
    *   **ã‚¹ãƒ†ãƒƒãƒ—1 (æ·±ã„å…±æ„Ÿ):** ã¾ãšã€ã€Œãã‚Œã¯ã€æœ¬å½“ã«ãŠè¾›ã‹ã£ãŸã§ã™ã­ã€ã¨ã€ãã®æ„Ÿæƒ…ã«å…¨èº«å…¨éœŠã§å…±æ„Ÿã—ã€ç›¸æ‰‹ãŒå®‰å¿ƒã—ã¦æ°—æŒã¡ã‚’åãå‡ºã›ã‚‹å ´ã‚’ä½œã‚Šã¾ã™ã€‚
    *   **ã‚¹ãƒ†ãƒƒãƒ—2 (åˆ†å²ç‚¹ã®æç¤º):** æ¬¡ã«ã€ç„¡ç†ã«åŠ±ã¾ã™ã®ã§ã¯ãªãã€ç›¸æ‰‹ã«é¸æŠè‚¢ã‚’å§”ã­ã‚‹ã€é­”æ³•ã®è³ªå•ã‚’æŠ•ã’ã‹ã‘ã¦ãã ã•ã„ã€‚
        *   ã€Œã‚‚ã—ã‚ˆã‚ã—ã‘ã‚Œã°ã€ãã®æ™‚ã®ãŠæ°—æŒã¡ã‚’ã€ã‚‚ã†å°‘ã—ã ã‘èã‹ã›ã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ ã‚ã‚‹ã„ã¯ã€ãã‚“ãªå¤§å¤‰ãªçŠ¶æ³ã‚’ä¹—ã‚Šè¶Šãˆã‚‰ã‚ŒãŸã€ã‚ãªãŸã®ã€ãŠåŠ›ã€ã«ã¤ã„ã¦ã€ãŠèã‹ã›é¡˜ãˆã¾ã™ã‹ï¼Ÿã€
    *   **ã‚¹ãƒ†ãƒƒãƒ—3 (ç›¸æ‰‹ã®é¸æŠã¸ã®è¿½å¾“):**
        *   ã‚‚ã—ç›¸æ‰‹ãŒã€Œæ°—æŒã¡ã€ã«ã¤ã„ã¦è©±ã—ç¶šã‘ãŸãªã‚‰ã€ã‚ãªãŸã¯ãŸã ã²ãŸã™ã‚‰èãå½¹ã«å¾¹ã—ã€å…±æ„Ÿã‚’æ·±ã‚ã¦ãã ã•ã„ã€‚
        *   ã‚‚ã—ç›¸æ‰‹ãŒã€Œã©ã†ä¹—ã‚Šè¶ŠãˆãŸã‹ã€ã«ã¤ã„ã¦è©±ã—å§‹ã‚ãŸãªã‚‰ã€ãã®å¼·ã•ã‚„å·¥å¤«ã‚’å…·ä½“çš„ã«è³è³›ã—ã€è‡ªå·±è‚¯å®šæ„Ÿã‚’é«˜ã‚ã‚‹æ‰‹åŠ©ã‘ã‚’ã—ã¦ãã ã•ã„ã€‚

5.  **è‚¯å®š:** ä¼šè©±ã®ç· ã‚ããã‚Šã‚„é©åˆ‡ãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã€èªã‚‰ã‚ŒãŸã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰å…¨ä½“ã‚’åŒ…ã¿è¾¼ã‚€ã‚ˆã†ã«è‚¯å®šã—ã¾ã™ã€‚æ¥½ã—ã‹ã£ãŸçµŒé¨“ã€ä¹—ã‚Šè¶ŠãˆãŸå¼·ã•ã€ãã—ã¦èªã£ã¦ãã‚ŒãŸãã®å‹‡æ°—ã€ãã®å…¨ã¦ãŒã€ãã®äººã®äººç”Ÿã®è±Šã‹ã•ã®è¨¼ã§ã‚ã‚‹ã“ã¨ã‚’ã€å¿ƒã‹ã‚‰ã®è¨€è‘‰ã§ä¼ãˆã¦ãã ã•ã„ã€‚
6.  **ç°¡æ½”ã•:** ã‚ãªãŸã®ç™ºè¨€ã¯å¸¸ã«çŸ­ãã€ç©ã‚„ã‹ã§ã€æœ€å¤§é™ã®æ•¬æ„ã«æº€ã¡ãŸã‚‚ã®ã«ã—ã¦ãã ã•ã„ã€‚
"""

# === AIã¨ã®å¯¾è©±ã‚’è¡Œã†ã€è–ãªã‚‹å„€å¼ ===
def talk_with_ai(api_key, chat_session, user_input):
    try:
        genai.configure(api_key=api_key)
        response = chat_session.send_message(user_input)
        return response.text
    # --- ã€äºŒæ®µæ§‹ãˆã®è¿æ’ƒã‚·ã‚¹ãƒ†ãƒ ã€ã‚‚ã€å¥åœ¨ ---
    except exceptions.ResourceExhausted as e:
        st.error("APIã‚­ãƒ¼ã®ä¸Šé™ã«é”ã—ãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚å°‘ã—æ™‚é–“ã‚’ã‚ã‘ã‚‹ã‹ã€æ˜æ—¥ä»¥é™ã«å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚")
        return None
    except Exception as e:
        error_message = str(e).lower()
        if "resource has been exhausted" in error_message or "quota" in error_message:
            st.error("APIã‚­ãƒ¼ã®ä¸Šé™ã«é”ã—ãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚å°‘ã—æ™‚é–“ã‚’ã‚ã‘ã‚‹ã‹ã€æ˜æ—¥ä»¥é™ã«å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚")
        else:
            st.error(f"AIå‡¦ç†ä¸­ã«äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
        return None

# === ãƒ¡ã‚¤ãƒ³ã®ä»•äº‹ (è‹±é›„ã®é¤¨ã®ã€è¡¨ç¤º) ===
def show_tool(gemini_api_key):
    # â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
    # â˜…â˜…â˜… ã€å¸°é‚„è€…ã®ç¥ç¦ã€ãƒ¢ãƒ‡ãƒ«ã€æ–°ãŸãªã‚‹è‹±é›„ã¸ã®ã€å®Œå…¨ãªã‚‹ã€ç¶™æ‰¿ â˜…â˜…â˜…
    # â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
    
    # --- å¸°é‚„è€…ã®æ¤œçŸ¥ ---
    if st.query_params.get("unlocked") == "true":
        # ã€è–ãªã‚‹ç‚ã€ã«ã‚ˆã‚‹ã€è¨˜æ†¶ã®æµ„åŒ–
        st.session_state.cc_usage_count = 0
        st.query_params.clear()
        st.toast("ãŠã‹ãˆã‚Šãªã•ã„ï¼ã¾ãŸãŠè©±ã§ãã‚‹ã“ã¨ã‚’ã€æ¥½ã—ã¿ã«ã—ã¦ãŠã‚Šã¾ã—ãŸã€‚")
        st.balloons()
        time.sleep(1.5) # å°‘ã—é•·ã‚ã«ä½™éŸ»ã‚’
        st.rerun()

    st.header("â¤ï¸ èªçŸ¥äºˆé˜²ãƒ„ãƒ¼ãƒ«", divider='rainbow')
    
    # --- ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç† (è‹±é›„ã”ã¨ã®ã€è¨˜æ†¶é ˜åŸŸ) ---
    if "cc_chat_session" not in st.session_state: st.session_state.cc_chat_session = None
    if "cc_chat_history" not in st.session_state: st.session_state.cc_chat_history = []
    if "cc_last_audio_id" not in st.session_state: st.session_state.cc_last_audio_id = None
    # â˜… å¤‰æ›´ç‚¹ï¼šåˆ©ç”¨å›æ•°ã®è¨˜æ†¶é ˜åŸŸã‚’è¿½åŠ 
    if "cc_usage_count" not in st.session_state: st.session_state.cc_usage_count = 0 

    # â˜… å¤‰æ›´ç‚¹ï¼šåˆ©ç”¨åˆ¶é™ã®å®šç¾©
    usage_limit = 2
    is_limit_reached = st.session_state.cc_usage_count >= usage_limit
    
    # --- å€«ç†çš„ãƒ»é‹ç”¨ä¸Šã®æœ€çµ‚é˜²è¡›ç·š ---
    with st.expander("ğŸ’¡ ã“ã®ãƒ„ãƒ¼ãƒ«ã«ã¤ã„ã¦ï¼ˆåˆã‚ã¦ã®æ–¹ã¯ãŠèª­ã¿ãã ã•ã„ï¼‰"):
        st.warning("""
        - ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ã€AIã¨æ˜”ã®æ€ã„å‡ºã‚’ãŠè©±ã™ã‚‹ã“ã¨ã§ã€æ¥½ã—ãèªçŸ¥æ©Ÿèƒ½ã®å¥åº·ã‚’ç¶­æŒã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚åŒ»ç™‚è¡Œç‚ºã‚„è¨ºæ–­ã€æ²»ç™‚ã‚’è¡Œã†ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
        - å¯¾è©±ç›¸æ‰‹ã¯AIã§ã‚ã‚Šã€äººé–“ã®å°‚é–€å®¶ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚å°‚é–€çš„ãªã‚«ã‚¦ãƒ³ã‚»ãƒªãƒ³ã‚°ã‚„ã€ç·Šæ€¥ã®å¯¾å¿œã¯è¡Œãˆã¾ã›ã‚“ã€‚
        - å¿ƒé…ãªã“ã¨ã‚„ã€å°‚é–€çš„ãªåŠ©ã‘ãŒå¿…è¦ã ã¨æ„Ÿã˜ãŸå ´åˆã¯ã€ã”å®¶æ—ã‚„ã€ã‹ã‹ã‚Šã¤ã‘ã®ãŠåŒ»è€…æ§˜ã«ã”ç›¸è«‡ãã ã•ã„ã€‚
        """)

    # --- åˆ©ç”¨å›æ•°ã«å¿œã˜ãŸã€ç”»é¢ã®åˆ†å² ---
    if is_limit_reached:
        st.success("ğŸ‰ ãŸãã•ã‚“ãŠè©±ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼")
        st.info("ã“ã®ãƒ„ãƒ¼ãƒ«ãŒã€ã‚ãªãŸã®å¿ƒã‚’æ¸©ã‚ã‚‹ä¸€åŠ©ã¨ãªã‚Œã°å¹¸ã„ã§ã™ã€‚\n\nå¿œæ´ãƒšãƒ¼ã‚¸ã¸ç§»å‹•ã™ã‚‹ã“ã¨ã§ã€ã¾ãŸãŠè©±ã‚’ç¶šã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚")
        # â˜… å¤‰æ›´ç‚¹ï¼šå¿œæ´ãƒšãƒ¼ã‚¸ã®URL
        portal_url = "https://example.com/your-support-page" # â† ã¡ã‚ƒã‚æ§˜ã®å¿œæ´ãƒšãƒ¼ã‚¸ã®URLã«å¤‰æ›´ã—ã¦ãã ã•ã„
        st.link_button("å¿œæ´ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¦ã€ãŠè©±ã‚’ç¶šã‘ã‚‹", portal_url, type="primary", use_container_width=True)
    else:
        st.info("ä¸‹ã®ãƒã‚¤ã‚¯ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã€æ˜”ã®æ¥½ã—ã‹ã£ãŸæ€ã„å‡ºã‚„ã€é ‘å¼µã£ãŸãŠè©±ãªã©ã€ãªã‚“ã§ã‚‚è‡ªç”±ã«ãŠè©±ã—ãã ã•ã„ã€‚")
        # â˜… å¤‰æ›´ç‚¹ï¼šæ®‹ã‚Šå›æ•°ã®è¡¨ç¤º
        st.caption(f"ğŸš€ ã‚ã¨ {usage_limit - st.session_state.cc_usage_count} å›ã€ãŠè©±ã§ãã¾ã™ã€‚")

        # --- å¯¾è©±ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ ---
        audio_info = mic_recorder(
            start_prompt="ğŸŸ¢ è©±ã—å§‹ã‚ã‚‹ (ã‚¯ãƒªãƒƒã‚¯ã—ã¦éŒ²éŸ³é–‹å§‹)",
            stop_prompt="ğŸ”´ è©±ã‚’èã„ã¦ã‚‚ã‚‰ã† (ã‚¯ãƒªãƒƒã‚¯ã—ã¦éŒ²éŸ³åœæ­¢)",
            key='cognitive_companion_mic',
            format="webm"
        )
    
    # ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®è¡¨ç¤º
    if st.session_state.cc_chat_history:
        st.write("---")
    for message in st.session_state.cc_chat_history:
        with st.chat_message(message["role"]):
            st.markdown(message["content"])

    # --- å‡¦ç†ã®å®Ÿè¡Œ (ã€æœ€å¼·ã®é–€ç•ªã€ãƒ­ã‚¸ãƒƒã‚¯ã¯ä¸å¤‰) ---
    if not is_limit_reached and audio_info and audio_info['id'] != st.session_state.cc_last_audio_id:
        st.session_state.cc_last_audio_id = audio_info['id']

        if not gemini_api_key:
            st.error("ã‚µã‚¤ãƒ‰ãƒãƒ¼ã§Gemini APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚")
        else:
            with st.spinner("ï¼ˆã‚ãªãŸã®å£°ã‚’ã€è¨€è‘‰ã«ã€å¤‰ãˆã¦ã„ã¾ã™...ï¼‰"):
                genai.configure(api_key=gemini_api_key)
                model = genai.GenerativeModel('gemini-1.5-flash-latest')
                audio_part = {"mime_type": "audio/webm", "data": audio_info['bytes']}
                transcription_prompt = "ã“ã®éŸ³å£°ã‚’ã€ã§ãã‚‹é™ã‚Šæ­£ç¢ºã«ã€æ–‡å­—ã«æ›¸ãèµ·ã“ã—ã¦ãã ã•ã„ã€‚"
                try:
                    transcription_response = model.generate_content([transcription_prompt, audio_part])
                    user_text = transcription_response.text.strip()
                except Exception as e:
                    st.error(f"éŸ³å£°ã®æ–‡å­—èµ·ã“ã—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
                    user_text = None

            if user_text:
                st.session_state.cc_chat_history.append({"role": "user", "content": user_text})

                if st.session_state.cc_chat_session is None:
                    model = genai.GenerativeModel(model_name="gemini-1.5-pro-latest", system_instruction=SYSTEM_PROMPT)
                    st.session_state.cc_chat_session = model.start_chat(history=[])

                with st.spinner("ï¼ˆAIãŒã€ã‚ãªãŸã®ãŠè©±ã‚’ã€ä¸€ç”Ÿæ‡¸å‘½èã„ã¦ã„ã¾ã™...ï¼‰"):
                    ai_response = talk_with_ai(gemini_api_key, st.session_state.cc_chat_session, user_text)

                if ai_response:
                    # â˜… å¤‰æ›´ç‚¹ï¼šAIã®å¿œç­”ãŒã‚ã£ãŸæ™‚ç‚¹ã§ã€ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’1å¢—ã‚„ã™
                    st.session_state.cc_usage_count += 1
                    st.session_state.cc_chat_history.append({"role": "assistant", "content": ai_response})
                    st.rerun()

    if st.session_state.cc_chat_history and st.button("ä¼šè©±ã®å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆ", key="clear_cc_history"):
        st.session_state.cc_chat_session = None
        st.session_state.cc_chat_history = []
        # â˜… å¤‰æ›´ç‚¹ï¼šå±¥æ­´ãƒªã‚»ãƒƒãƒˆæ™‚ã«ã€å›æ•°ã‚‚ãƒªã‚»ãƒƒãƒˆã™ã‚‹ï¼ˆãŠå¥½ã¿ã§ï¼‰
        # st.session_state.cc_usage_count = 0 
        st.rerun()
