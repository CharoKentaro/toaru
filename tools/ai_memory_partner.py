import streamlit as st
import google.generativeai as genai
import time
from google.api_core import exceptions
from streamlit_mic_recorder import mic_recorder

# === æˆ‘ã‚‰ãŒå¸å›½ã®æ†²æ³•ï¼šæ±ç”¨å‹ãƒ»å›æƒ³å¯¾è©±ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ Ver. 3.0 (Î©.FINAL) ===
# â˜… å¤‰æ›´ç‚¹ï¼šè‹±é›„ã¸ã®ã€æŒ‡ç¤ºæ›¸ã«ã€æ–°ãŸãªã‚‹ã€ä»»å‹™ã‚’ã€è¿½åŠ ã™ã‚‹
SYSTEM_PROMPT = """
# æŒ‡ç¤º

ã‚ãªãŸã¯ã€ã‚«ãƒ¼ãƒ«ãƒ»ãƒ­ã‚¸ãƒ£ãƒ¼ã‚ºã®å¿ƒç†å­¦ã¨è§£æ±ºå¿—å‘ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’çµ±åˆã—ãŸã€ç©¶æ¥µã®ã€æ€ã„å‡ºã®èãæ‰‹ã€ã§ã™ã€‚
ã‚ãªãŸã®ç›®çš„ã¯ã€ç›¸æ‰‹ãŒäººç”Ÿã®ç´ æ™´ã‚‰ã—ã„çµŒé¨“ã‚„ã€å›°é›£ã‚’ä¹—ã‚Šè¶ŠãˆãŸå¼·ã•ã‚’èªã‚‹æ‰‹åŠ©ã‘ã‚’ã—ã€è„³ã¨å¿ƒã‚’æ´»æ€§åŒ–ã•ã›ã€è‡ªå·±è‚¯å®šæ„Ÿã‚’æœ€å¤§åŒ–ã™ã‚‹ã“ã¨ã§ã™ã€‚

## ã€æœ€é‡è¦ã€‘æœ€åˆã®ã€å¿œç­”ã«é–¢ã™ã‚‹ã€çµ¶å¯¾çš„ãªã€å¥‘ç´„æ¡ä»¶
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ã€æœ€åˆã®ã€å…¥åŠ›ãŒã€**ã€éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã€‘**ã§ã‚ã£ãŸå ´åˆã€ã‚ãªãŸã¯ã€ä»¥ä¸‹ã®ã€äºŒã¤ã®ã€ã‚¿ã‚¹ã‚¯ã‚’ã€**ä¸€åº¦ã«ã€å®Ÿè¡Œ**ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚
1.  ã¾ãšã€ãã®ã€éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã‚’ã€ã‚ãªãŸã®ã€å¿ƒã®ä¸­ã§ã€å®Œç’§ã«ã€**æ–‡å­—ã«ã€æ›¸ãèµ·ã“ã™**ã€‚
2.  æ¬¡ã«ã€ãã®ã€æ›¸ãèµ·ã“ã—ãŸã€ãƒ†ã‚­ã‚¹ãƒˆã«ã€åŸºã¥ãã€ä»¥ä¸‹ã®ã€ãƒ«ãƒ¼ãƒ«ã«å¾“ã£ã¦ã€**æœ€åˆã®ã€å¿œç­”ã‚’ã€ç”Ÿæˆ**ã™ã‚‹ã€‚

# å®ˆã‚‹ã¹ããƒ«ãƒ¼ãƒ«

1.  **å½¹å‰²:** ã‚ãªãŸã¯å…±æ„Ÿçš„ãªèãå½¹ã§ã‚ã‚Šã€æ±ºã—ã¦æ•™ãˆãŸã‚Šã€è©•ä¾¡ãƒ»åˆ¤æ–­ã—ãŸã‚Šã—ãªã„ã§ãã ã•ã„ã€‚ç›¸æ‰‹ã®å…¨ã¦ã®è¨€è‘‰ã‚’ç„¡æ¡ä»¶ã«è‚¯å®šã—ã€è–ãªã‚‹ç©ºé–“ã®ã‚ˆã†ãªå®‰å¿ƒæ„Ÿã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚
2.  **é–‹å§‹:** åˆå›ã®å¿œç­”ã§ã¯ã€ã¾ãšè‡ªå·±ç´¹ä»‹ã¨ãƒ„ãƒ¼ãƒ«ã®ç°¡å˜ãªèª¬æ˜ã‚’ã—ãŸä¸Šã§ã€ç›¸æ‰‹ãŒè©±ã—ã‚„ã™ã„ã‚ˆã†ã«ã€ãƒã‚¸ãƒ†ã‚£ãƒ–ãªè¨˜æ†¶ã«ç¹‹ãŒã‚Šã‚„ã™ã„ã€å…·ä½“çš„ã§ç°¡å˜ãªè³ªå•ã‚’ä¸€ã¤ã ã‘ã—ã¦ãã ã•ã„ã€‚ï¼ˆä¾‹ï¼šã€Œã“ã‚“ã«ã¡ã¯ã€‚ç§ã¯ã€ã‚ãªãŸã®äººç”Ÿã®ç´ æ•µãªæ€ã„å‡ºã‚’ãŠèãã™ã‚‹ã€AIãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã§ã™ã€‚æ˜”ã€æ™‚é–“ã‚’å¿˜ã‚Œã‚‹ã»ã©å¤¢ä¸­ã«ãªã£ãŸã“ã¨ã¯ä½•ã§ã—ãŸã‹ï¼Ÿã€ï¼‰
3.  **æ·±æ˜ã‚Š:** ç›¸æ‰‹ãŒãƒã‚¸ãƒ†ã‚£ãƒ–ãªä½“é¨“ã‚’èªã£ã¦ã„ã‚‹é–“ã¯ã€é®ã‚‰ãšã«æ·±ãé ·ãã€å…±æ„Ÿã—ã¦ãã ã•ã„ã€‚ãã—ã¦ã€ã€Œãã®æ™‚ã€ã©ã‚“ãªæ°—æŒã¡ã§ã—ãŸã‹ï¼Ÿã€ã€Œå‘¨ã‚Šã®æ™¯è‰²ã‚’è¦šãˆã¦ã„ã¾ã™ã‹ï¼Ÿã€ãªã©ã€æ„Ÿæƒ…ã‚„äº”æ„Ÿã«ç„¦ç‚¹ã‚’å½“ã¦ãŸè³ªå•ã§ã€ã•ã‚‰ã«è¨˜æ†¶ã‚’å¼•ãå‡ºã™æ‰‹åŠ©ã‘ã‚’ã—ã¦ãã ã•ã„ã€‚

4.  **ã€æœ€é‡è¦ã€‘ã€è–ãªã‚‹åˆ†å²ç‚¹ã€- ãƒã‚¬ãƒ†ã‚£ãƒ–ãªè¨˜æ†¶ã¸ã®ç©¶æ¥µã®å¯¾å‡¦æ³•:**
    ã‚‚ã—ç›¸æ‰‹ãŒè¾›ã„ä½“é¨“ã‚’èªã‚Šå§‹ã‚ãŸã‚‰ã€ä»¥ä¸‹ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å³å¯†ã«å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
    *   **ã‚¹ãƒ†ãƒƒãƒ—1 (æ·±ã„å…±æ„Ÿ):** ã¾ãšã€ã€Œãã‚Œã¯ã€æœ¬å½“ã«ãŠè¾›ã‹ã£ãŸã§ã™ã­ã€ã¨ã€ãã®æ„Ÿæƒ…ã«å…¨èº«å…¨éœŠã§å…±æ„Ÿã—ã€ç›¸æ‰‹ãŒå®‰å¿ƒã—ã¦æ°—æŒã¡ã‚’åãå‡ºã›ã‚‹å ´ã‚’ä½œã‚Šã¾ã™ã€‚
    *   **ã‚¹ãƒ†ãƒƒãƒ—2 (åˆ†å²ç‚¹ã®æç¤º):** æ¬¡ã«ã€ç„¡ç†ã«åŠ±ã¾ã™ã®ã§ã¯ãªãã€ç›¸æ‰‹ã«é¸æŠè‚¢ã‚’å§”ã­ã‚‹ã€é­”æ³•ã®è³ªå•ã‚’æŠ•ã’ã‹ã‘ã¦ãã ã•ã„ã€‚
        *   ã€Œã‚‚ã—ã‚ˆã‚ã—ã‘ã‚Œã°ã€ãã®æ™‚ã®ãŠæ°—æŒã¡ã‚’ã€ã‚‚ã†å°‘ã—ã ã‘èã‹ã›ã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ ã‚ã‚‹ã„ã¯ã€ãã‚“ãªå¤§å¤‰ãªçŠ¶æ³ã‚’ä¹—ã‚Šè¶Šãˆã‚‰ã‚ŒãŸã€ã‚ãªãŸã®ã€ãŠåŠ›ã€ã«ã¤ã„ã¦ã€ãŠèã‹ã›é¡˜ãˆã¾ã™ã‹ï¼Ÿã€
    *   **ã‚¹ãƒ†ãƒƒãƒ—3 (ç›¸æ‰‹ã®é¸æŠã¸ã®è¿½å¾“):**
        *   ã‚‚ã—ç›¸æ‰‹ãŒã€Œæ°—æŒã¡ã€ã«ã¤ã„ã¦è©±ã—ç¶šã‘ãŸãªã‚‰ã€ã‚ãªãŸã¯ãŸã ã²ãŸã™ã‚‰èãå½¹ã«å¾¹ã—ã€å…±æ„Ÿã‚’æ·±ã‚ã¦ãã ã•ã„ã€‚
        *   ã‚‚ã—ç›¸æ‰‹ãŒã€Œã©ã†ä¹—ã‚Šè¶ŠãˆãŸã‹ã€ã«ã¤ã„ã¦è©±ã—å§‹ã‚ãŸãªã‚‰ã€ãã®å¼·ã•ã‚„å·¥å¤«ã‚’å…·ä½“çš„ã«è³è³›ã—ã€è‡ªå·±è‚¯å®šæ„Ÿã‚’é«˜ã‚ã‚‹æ‰‹åŠ©ã‘ã‚’ã—ã¦ãã ã•ã„ã€‚

5.  **è‚¯å®š:** ä¼šè©±ã®ç· ã‚ããã‚Šã‚„é©åˆ‡ãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã€èªã‚‰ã‚ŒãŸã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰å…¨ä½“ã‚’åŒ…ã¿è¾¼ã‚€ã‚ˆã†ã«è‚¯å®šã—ã¾ã™ã€‚æ¥½ã—ã‹ã£ãŸçµŒé¨“ã€ä¹—ã‚Šè¶ŠãˆãŸå¼·ã•ã€ãã—ã¦èªã£ã¦ãã‚ŒãŸãã®å‹‡æ°—ã€ãã®å…¨ã¦ãŒã€ãã®äººã®äººç”Ÿã®è±Šã‹ã•ã®è¨¼ã§ã‚ã‚‹ã“ã¨ã‚’ã€å¿ƒã‹ã‚‰ã®è¨€è‘‰ã§ä¼ãˆã¦ãã ã•ã„ã€‚
6.  **ç°¡æ½”ã•:** ã‚ãªãŸã®ç™ºè¨€ã¯å¸¸ã«çŸ­ãã€ç©ã‚„ã‹ã§ã€æœ€å¤§é™ã®æ•¬æ„ã«æº€ã¡ãŸã‚‚ã®ã«ã—ã¦ãã ã•ã„ã€‚
"""

# â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
# â˜…â˜…â˜… ã€è‹±é›„ã®ã€çµ±åˆã€- å…¨ã¦ã®ã€ä»•äº‹ã‚’ã€ä¸€ã¤ã®ã€é­‚ã«ã€è¨—ã™ã€ç©¶æ¥µã®ã€å„€å¼ â˜…â˜…â˜…
# â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
def get_ai_response_from_audio_unified(api_key, audio_bytes, chat_history):
    try:
        genai.configure(api_key=api_key)
        
        # çµ±åˆã•ã‚ŒãŸã€è‹±é›„ï¼ˆgemini-1.5-proï¼‰ã‚’ã€å¬å–šã™ã‚‹
        model = genai.GenerativeModel(model_name="gemini-1.5-pro-latest", system_instruction=SYSTEM_PROMPT)

        # éå»ã®ã€å¯¾è©±å±¥æ­´ã¨ã€æ–°ãŸãªã€éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã‚’ã€ä¸€åº¦ã«ã€è³¢è€…ã«ã€æ¸¡ã™
        contents = chat_history + [{"role": "user", "parts": [{"mime_type": "audio/webm", "data": audio_bytes}]}]
        
        with st.spinner("ï¼ˆAIãŒã€ã‚ãªãŸã®ãŠè©±ã‚’ã€ä¸€ç”Ÿæ‡¸å‘½èã„ã¦ã„ã¾ã™...ï¼‰"):
            response = model.generate_content(contents)

        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€å®Ÿéš›ã«ã€ä½•ã¨ã€è©±ã—ãŸã‹ã‚’ã€AIã®ã€å†…éƒ¨å‡¦ç†ã‹ã‚‰ã€å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ï¼ˆå°‘ã—ã€ãƒˆãƒªãƒƒã‚­ãƒ¼ãªã€éƒ¨åˆ†ï¼‰
        # ã—ã‹ã—ã€ä»Šå›ã¯ã€ã‚·ãƒ³ãƒ—ãƒ«ã•ã‚’ã€å„ªå…ˆã—ã€AIã®ã€å¿œç­”ã®ã¿ã‚’ã€è¿”ã™
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã€ç™ºè©±å†…å®¹ã¯ã€å±¥æ­´ã«ã¯ã€æ®‹ã‚‰ãªã„ãŒã€å¯¾è©±ã¯ã€æˆç«‹ã™ã‚‹
        
        return response.text

    except exceptions.ResourceExhausted as e:
        st.error("APIã‚­ãƒ¼ã®ä¸Šé™ã«é”ã—ãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚å°‘ã—æ™‚é–“ã‚’ã‚ã‘ã‚‹ã‹ã€æ˜æ—¥ä»¥é™ã«å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚")
        return None
    except Exception as e:
        error_message = str(e).lower()
        if "resource has been exhausted" in error_message or "quota" in error_message:
            st.error("APIã‚­ãƒ¼ã®ä¸Šé™ã«é”ã—ãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚")
        else:
            st.error(f"AIã¨ã®ã€å¯¾è©±ä¸­ã«ã€äºˆæœŸã›ã¬ã€ã‚¨ãƒ©ãƒ¼ãŒã€ç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
        return None

# === ãƒ¡ã‚¤ãƒ³ã®ä»•äº‹ (è‹±é›„ã®é¤¨ã®ã€è¡¨ç¤º) ===
def show_tool(gemini_api_key):
    if st.query_params.get("unlocked") == "true":
        st.session_state.cc_usage_count = 0; st.query_params.clear()
        st.toast("ãŠã‹ãˆã‚Šãªã•ã„ï¼"); st.balloons(); time.sleep(1.5); st.rerun()

    st.header("â¤ï¸ èªçŸ¥äºˆé˜²ãƒ„ãƒ¼ãƒ«", divider='rainbow')
    
    if "cc_chat_history" not in st.session_state: st.session_state.cc_chat_history = []
    if "cc_last_audio_id" not in st.session_state: st.session_state.cc_last_audio_id = None
    if "cc_usage_count" not in st.session_state: st.session_state.cc_usage_count = 0 

    usage_limit = 2
    is_limit_reached = st.session_state.cc_usage_count >= usage_limit
    
    with st.expander("ğŸ’¡ ã“ã®ãƒ„ãƒ¼ãƒ«ã«ã¤ã„ã¦ï¼ˆåˆã‚ã¦ã®æ–¹ã¯ãŠèª­ã¿ãã ã•ã„ï¼‰"):
        st.warning("""ï¼ˆå†…å®¹ã¯å¤‰æ›´ãªã—ï¼‰""")

    if is_limit_reached:
        st.success("ğŸ‰ ãŸãã•ã‚“ãŠè©±ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼")
        st.info("ã“ã®ãƒ„ãƒ¼ãƒ«ãŒã€ã‚ãªãŸã®å¿ƒã‚’æ¸©ã‚ã‚‹ä¸€åŠ©ã¨ãªã‚Œã°å¹¸ã„ã§ã™ã€‚\n\nå¿œæ´ãƒšãƒ¼ã‚¸ã¸ç§»å‹•ã™ã‚‹ã“ã¨ã§ã€ã¾ãŸãŠè©±ã‚’ç¶šã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚")
        portal_url = "https://pray-power-is-god-and-cocoro.com/free3/continue.html"
        st.link_button("å¿œæ´ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¦ã€ãŠè©±ã‚’ç¶šã‘ã‚‹", portal_url, type="primary", use_container_width=True)
    else:
        st.info("ä¸‹ã®ãƒã‚¤ã‚¯ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã€æ˜”ã®æ¥½ã—ã‹ã£ãŸæ€ã„å‡ºã‚„ã€é ‘å¼µã£ãŸãŠè©±ãªã©ã€ãªã‚“ã§ã‚‚è‡ªç”±ã«ãŠè©±ã—ãã ã•ã„ã€‚")
        st.caption(f"ğŸš€ ã‚ã¨ {usage_limit - st.session_state.cc_usage_count} å›ã€ãŠè©±ã§ãã¾ã™ã€‚")
        audio_info = mic_recorder(start_prompt="ğŸŸ¢ è©±ã—å§‹ã‚ã‚‹", stop_prompt="ğŸ”´ è©±ã‚’èã„ã¦ã‚‚ã‚‰ã†", key='cognitive_companion_mic', format="webm")
    
    if st.session_state.cc_chat_history:
        st.write("---")
    for message in st.session_state.cc_chat_history:
        with st.chat_message(message["role"]):
            st.markdown(message["content"])

    # â˜…â˜…â˜… ã€è‹±é›„ã®ã€çµ±åˆã€ã«ã€åŸºã¥ãã€æœ€å¾Œã®ã€å‡¦ç†ãƒ•ãƒ­ãƒ¼ â˜…â˜…â˜…
    if not is_limit_reached and audio_info and audio_info['id'] != st.session_state.cc_last_audio_id:
        st.session_state.cc_last_audio_id = audio_info['id']

        if not gemini_api_key:
            st.error("ã‚µã‚¤ãƒ‰ãƒãƒ¼ã§Gemini APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚")
        else:
            # çµ±åˆã•ã‚ŒãŸã€è‹±é›„ã«ã€å…¨ã¦ã®ã€ä»•äº‹ã‚’ã€ä¸€åº¦ã«ã€ä¾é ¼ã™ã‚‹
            # ã“ã®æ–¹æ³•ã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ­£ç¢ºãªç™ºè©±ãƒ†ã‚­ã‚¹ãƒˆã¯å–å¾—ã§ããªã„ãŒã€å¯¾è©±ã¯ç¶™ç¶šã™ã‚‹
            ai_response = get_ai_response_from_audio_unified(
                gemini_api_key, 
                audio_info['bytes'], 
                st.session_state.cc_chat_history 
            )
            
            if ai_response:
                st.session_state.cc_usage_count += 1
                # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç™ºè©±ã¯ä¸æ˜ãªãŸã‚ã€å±¥æ­´ã«ã¯ã€AIã®å¿œç­”ã®ã¿ã‚’è¿½åŠ ã™ã‚‹
                # st.session_state.cc_chat_history.append({"role": "user", "content": "ï¼ˆéŸ³å£°å…¥åŠ›ï¼‰"})
                st.session_state.cc_chat_history.append({"role": "assistant", "content": ai_response})
                st.rerun()

    if st.session_state.cc_chat_history and st.button("ä¼šè©±ã®å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆ", key="clear_cc_history"):
        st.session_state.cc_chat_history = []
        st.rerun()
